# Docker Compose Environment Configuration
# Uses .env.core-chain for service environment variables

services:
  # SCALEX API service
  scalex-api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    env_file:
      - ./.env.core-chain
    environment:
      - DATABASE_URL=postgresql://postgres:password@scalex-postgres:5432/scalex_api
      - NODE_ENV=production
      - PORT=3000
    depends_on:
      - scalex-postgres
      - redis
    networks:
      - scalex-network
    restart: unless-stopped
    volumes:
      - ./api/logs:/app/logs

  # SCALEX API database
  scalex-postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=scalex_api
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5435:5432"
    volumes:
      - scalex_postgres_data:/var/lib/postgresql/data
    networks:
      - scalex-network
    restart: unless-stopped

  # Core indexer service (existing)
  clob-indexer:
    build:
      context: .
      dockerfile: Dockerfile
    # Use host networking to connect to localhost:5433
    network_mode: "host"
    env_file:
      - ./.env.core-chain
    environment:
      - PONDER_DATABASE_URL=postgresql://postgres:password@localhost:5433/ponder_core
      - REDIS_URL=redis://localhost:6380
      - ENABLE_EVENT_PUBLISHING=true
      - ENABLE_WEBSOCKET=false  # Disabled in favor of separate websocket service
      - PONDER_PORT=42070
    depends_on:
      - postgres
      - redis
    volumes:
      - ./logs:/app/logs

  # WebSocket service
  websocket-service:
    build:
      context: ./websocket-service
      dockerfile: Dockerfile
    ports:
      - "42080:42080"
      - "42084:8080"  # Health port changed to avoid conflict    
    env_file:
      - ./.env.core-chain
    environment:
      - PORT=42080
      - HEALTH_PORT=8080
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/ponder_core
      - CONSUMER_GROUP=websocket-consumers
      - CONSUMER_ID=ws-consumer-1
      - BATCH_SIZE=10
      - POLL_INTERVAL=1000
      - WS_PING_INTERVAL=30000
      - MAX_CONNECTIONS=1000
    depends_on:
      - postgres
      - redis
    networks:
      - scalex-network
    restart: unless-stopped

  # Analytics service
  analytics-service:
    build:
      context: ./analytics-service
      dockerfile: Dockerfile
    ports:
      - "42090:42090"
    env_file:
      - ./.env.core-chain
    environment:
      - PORT=42090
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/ponder_core
      - TIMESCALE_DATABASE_URL=postgresql://postgres:password@timescaledb:5432/analytics
      - CONSUMER_GROUP=analytics-consumers
      - CONSUMER_ID=analytics-consumer-1
      - ANALYTICS_BATCH_SIZE=5
      - ANALYTICS_POLL_INTERVAL=5000
      - CACHE_TTL=300
      - ENABLE_DAILY_SNAPSHOTS=true
      - ENABLE_HOURLY_AGGREGATION=true
      - ENABLE_CACHE_REFRESH=true
    depends_on:
      - postgres
      - timescaledb
      - redis
    networks:
      - scalex-network
    restart: unless-stopped

  # PostgreSQL database (Main indexer DB)
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=ponder_core
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5433:5432"  # Use port 5433 externally to avoid conflict
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - scalex-network
    restart: unless-stopped

  # TimescaleDB for Analytics
  timescaledb:
    image: timescale/timescaledb:latest-pg15
    environment:
      - POSTGRES_DB=analytics
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5434:5432"  # Use port 5434 externally
    volumes:
      - timescale_data:/var/lib/postgresql/data
      - ./analytics-service/init:/docker-entrypoint-initdb.d
    command: ["postgres", "-c", "shared_preload_libraries=timescaledb"]
    networks:
      - scalex-network
    restart: unless-stopped

  # Redis for caching and message queuing
  redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"  # Map external port 6380 to internal port 6379
    volumes:
      - redis_data:/data
    networks:
      - scalex-network
    restart: unless-stopped
    command: redis-server --appendonly yes


  # Monitoring services (COMMENTED OUT)
  # prometheus:
  #   image: prom/prometheus:latest
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus_data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--web.console.libraries=/etc/prometheus/console_libraries'
  #     - '--web.console.templates=/etc/prometheus/consoles'
  #   networks:
  #     - scalex-network
  #   restart: unless-stopped

  # grafana:
  #   image: grafana/grafana:latest
  #   ports:
  #     - "3001:3000"  # Changed from 3000 to avoid conflict with scalex-api
  #   environment:
  #     - GF_SECURITY_ADMIN_PASSWORD=admin
  #   volumes:
  #     - grafana_data:/var/lib/grafana
  #     - ./monitoring/grafana-dashboards:/etc/grafana/provisioning/dashboards:ro
  #     - ./monitoring/grafana-datasources:/etc/grafana/provisioning/datasources:ro
  #   depends_on:
  #     - prometheus
  #   networks:
  #     - scalex-network
  #   restart: unless-stopped

  # Redis Commander for Redis management (dev only)
  redis-commander:
    image: rediscommander/redis-commander:latest
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379
    depends_on:
      - redis
    networks:
      - scalex-network
    profiles:
      - dev
    restart: unless-stopped

volumes:
  postgres_data:
  scalex_postgres_data:
  timescale_data:
  redis_data:
  # prometheus_data:
  # grafana_data:

networks:
  scalex-network:
    driver: bridge
  coolify:
    external: true
