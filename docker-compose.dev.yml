# Docker Compose for Local Development
# Includes host port mappings for local access

services:
  # SCALEX API service
  scalex-api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "8000:3000"  # Host port 8000 for local development
    env_file:
      - ./.env.core-chain
    environment:
      - DATABASE_URL=postgresql://postgres:password@scalex-postgres:5432/scalex_api
      - NODE_ENV=development
      - PORT=3000
    depends_on:
      - scalex-postgres
      - redis
    networks:
      - scalex-network
    restart: unless-stopped
    volumes:
      - ./api/logs:/app/logs
      - ./api:/app  # Mount for hot reloading in dev

  # SCALEX API database
  scalex-postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=scalex_api
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5435:5432"  # Host port for local access
    volumes:
      - scalex_postgres_data:/var/lib/postgresql/data
    networks:
      - scalex-network
    restart: unless-stopped

  # Core indexer service (existing)
  clob-indexer:
    build:
      context: .
      dockerfile: Dockerfile
    # Use host networking to connect to localhost:5433
    network_mode: "host"
    env_file:
      - ./.env.core-chain
    environment:
      - PONDER_DATABASE_URL=postgresql://postgres:password@localhost:5433/ponder_core
      - REDIS_URL=redis://localhost:6380
      - ENABLE_EVENT_PUBLISHING=true
      - ENABLE_WEBSOCKET=false  # Disabled in favor of separate websocket service
      - PONDER_PORT=42070
    depends_on:
      - postgres
      - redis
    volumes:
      - ./logs:/app/logs
      - .:/app  # Mount for hot reloading in dev

  # WebSocket service
  websocket-service:
    build:
      context: ./websocket-service
      dockerfile: Dockerfile
    ports:
      - "42080:42080"  # Host ports for local development
      - "42084:8080"  # Health port
    env_file:
      - ./.env.core-chain
    environment:
      - PORT=42080
      - HEALTH_PORT=8080
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/ponder_core
      - CONSUMER_GROUP=websocket-consumers
      - CONSUMER_ID=ws-consumer-1
      - BATCH_SIZE=10
      - POLL_INTERVAL=1000
      - WS_PING_INTERVAL=30000
      - MAX_CONNECTIONS=1000
    depends_on:
      - postgres
      - redis
    networks:
      - scalex-network
    restart: unless-stopped
    volumes:
      - ./websocket-service:/app  # Mount for hot reloading in dev

  # Analytics service
  analytics-service:
    build:
      context: ./analytics-service
      dockerfile: Dockerfile
    ports:
      - "42090:42090"  # Host port for local development
    env_file:
      - ./.env.core-chain
    environment:
      - PORT=42090
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/ponder_core
      - TIMESCALE_DATABASE_URL=postgresql://postgres:password@timescaledb:5432/analytics
      - CONSUMER_GROUP=analytics-consumers
      - CONSUMER_ID=analytics-consumer-1
      - ANALYTICS_BATCH_SIZE=5
      - ANALYTICS_POLL_INTERVAL=5000
      - CACHE_TTL=300
      - ENABLE_DAILY_SNAPSHOTS=true
      - ENABLE_HOURLY_AGGREGATION=true
      - ENABLE_CACHE_REFRESH=true
    depends_on:
      - postgres
      - timescaledb
      - redis
    networks:
      - scalex-network
    restart: unless-stopped
    volumes:
      - ./analytics-service:/app  # Mount for hot reloading in dev

  # PostgreSQL database (Main indexer DB)
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=ponder_core
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5433:5432"  # Host port for local access
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - scalex-network
    restart: unless-stopped

  # TimescaleDB for Analytics
  timescaledb:
    image: timescale/timescaledb:latest-pg15
    environment:
      - POSTGRES_DB=analytics
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5434:5432"  # Host port for local access
    volumes:
      - timescale_data:/var/lib/postgresql/data
      - ./analytics-service/init:/docker-entrypoint-initdb.d
    command: ["postgres", "-c", "shared_preload_libraries=timescaledb"]
    networks:
      - scalex-network
    restart: unless-stopped

  # Redis for caching and message queuing
  redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"  # Host port for local access
    volumes:
      - redis_data:/data
    networks:
      - scalex-network
    restart: unless-stopped
    command: redis-server --appendonly yes

  # Development tools
  redis-commander:
    image: rediscommander/redis-commander:latest
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379
    depends_on:
      - redis
    networks:
      - scalex-network
    restart: unless-stopped

volumes:
  postgres_data:
  scalex_postgres_data:
  timescale_data:
  redis_data:

networks:
  scalex-network:
    driver: bridge